<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gestão de Projetos CDR Sul</title>
    <style>
        /* [todo o CSS original permanece inalterado aqui] */
    </style>
</head>
<body>
    <div class="main-container">
        <!-- O conteúdo será carregado dinamicamente pelo JavaScript -->
    </div>
    <script>
        // [todo o JavaScript permanece como está até as funções a seguir]

        // ===== PROCESSAR ENVIO DE RELATÓRIO =====
        async function handleSubmitReport(event) {
            event.preventDefault();
            const reportType = document.getElementById('reportType').value;
            const reportDate = document.getElementById('reportDate').value;
            const title = document.getElementById('reportTitle').value;
            const description = document.getElementById('reportDescription').value;
            const filesInput = document.getElementById('reportFiles');
            const files = await Promise.all([...filesInput.files].map(fileToJSON));
            try {
                const result = await sendRequest({
                    action: 'submitReport',
                    email: currentUser.email,
                    reportType,
                    reportDate,
                    title,
                    description,
                    files
                });
                if (result.success) {
                    alert('Relatório enviado com sucesso!');
                    document.getElementById('reportForm').reset();
                    loadUserData();
                } else {
                    alert('Erro ao enviar relatório: ' + result.message);
                }
            } catch (error) {
                alert('Erro de conexão');
            }
        }

        // ===== PROCESSAR CADASTRO DE ATIVIDADE =====
        async function handleSubmitActivity(event) {
            event.preventDefault();
            const activityType = document.getElementById('activityType').value;
            const activityDate = document.getElementById('activityDate').value;
            const description = document.getElementById('activityDescription').value;
            const filesInput = document.getElementById('activityFiles');
            const files = await Promise.all([...filesInput.files].map(fileToJSON));
            try {
                const result = await sendRequest({
                    action: 'submitActivity',
                    email: currentUser.email,
                    name: activityType,
                    date: activityDate,
                    description,
                    files
                });
                if (result.success) {
                    alert('Atividade cadastrada!');
                    document.getElementById('activityForm').reset();
                    loadUserData();
                } else {
                    alert('Erro ao cadastrar: ' + result.message);
                }
            } catch (e) {
                alert('Erro de conexão');
            }
        }

        // ===== PROCESSAR UPLOAD DE ARQUIVOS =====
        async function handleUploadFiles(event) {
            event.preventDefault();
            const category = document.getElementById('fileCategory').value;
            const description = document.getElementById('fileDescription').value;
            const filesInput = document.getElementById('uploadFiles');
            const files = await Promise.all([...filesInput.files].map(fileToJSON));
            try {
                const result = await sendRequest({
                    action: 'uploadFiles',
                    email: currentUser.email,
                    category,
                    description,
                    files
                });
                if (result.success) {
                    alert('Arquivos enviados!');
                    document.getElementById('filesForm').reset();
                    loadUserData();
                } else {
                    alert('Erro: ' + result.message);
                }
            } catch (e) {
                alert('Erro de conexão');
            }
        }

        // ===== ENVIAR REQUISIÇÃO =====
        async function sendRequest(data) {
            try {
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify(data)
                });
                return await response.json();
            } catch (error) {
                throw error;
            }
        }

        async function fileToJSON(file) {
            const buffer = await file.arrayBuffer();
            const base64 = btoa(String.fromCharCode(...new Uint8Array(buffer)));
            return {
                name: file.name,
                data: base64,
                size: file.size,
                type: file.type
            };
        }

        // ===== AJUSTE DE ADMIN =====
        async function loadUserData() {
            try {
                const result = await sendRequest({
                    action: 'getUserStats',
                    email: currentUser.email
                });
                if (result.success && result.data) {
                    const d = result.data;
                    document.getElementById('statsReports').textContent = d.reports;
                    document.getElementById('statsActivities').textContent = d.activities;
                    document.getElementById('statsFiles').textContent = d.files;
                }
            } catch (e) {
                console.warn('Erro ao carregar dados do usuário');
            }
        }

        async function loadAdminData() {
            try {
                const result = await sendRequest({
                    action: 'getAdminData',
                    email: currentUser.email
                });
                if (!result.success || !result.data) return;
                const d = result.data;
                document.getElementById('adminStatsUsers').textContent = d.totalUsers;
                document.getElementById('adminStatsReports').textContent = d.totalReports;
                document.getElementById('adminStatsActivities').textContent = d.totalActivities;
                document.getElementById('adminUsersList').innerHTML = d.users.map(u => `<div class="admin-item"><strong>${u.name}</strong><br>${u.email}<br><small>${u.institution} - ${u.project}</small></div>`).join('');
                document.getElementById('adminReportsList').innerHTML = d.recentReports.map(r => `<div class="admin-item"><strong>${r.title}</strong><br>${r.userEmail}<br><small>${new Date(r.date).toLocaleDateString()}</small></div>`).join('');
                document.getElementById('adminActivitiesList').innerHTML = d.recentActivities.map(a => `<div class="admin-item"><strong>${a.title}</strong><br>${a.userEmail}<br><small>${new Date(a.date).toLocaleDateString()} - ${a.location || ''}</small></div>`).join('');
            } catch (e) {
                console.warn('Erro ao carregar dados admin');
            }
        }

    </script>
</body>
</html>
