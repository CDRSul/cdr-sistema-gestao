<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema CDR Sul Tocantins</title>
    <style>
        /* Estilos existentes permanecem os mesmos */
        .hidden { display: none; }
        .message { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .message-success { background: #d4edda; color: #155724; }
        .message-error { background: #f8d7da; color: #721c24; }
        .message-info { background: #d1ecf1; color: #0c5460; }
        .container { max-width: 600px; margin: 50px auto; padding: 20px; background: white; border-radius: 8px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; }
        .form-group input, .form-group select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        button { width: 100%; padding: 10px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .file-list { margin-top: 10px; color: #333; }
    </style>
</head>
<body>
    <div id="messageArea"></div>

    <div id="loginContainer" class="container">
        <h2>Login</h2>
        <form id="loginForm">
            <div class="form-group">
                <label for="email">E-mail:</label>
                <input type="email" id="email" required>
            </div>
            <div class="form-group">
                <label for="password">Senha:</label>
                <input type="password" id="password" required>
            </div>
            <button type="submit" id="loginBtn">Entrar</button>
            <p><a href="#" id="showRegisterLink">Cadastrar-se</a></p>
        </form>
    </div>

    <div id="registerContainer" class="container hidden">
        <h2>Cadastro</h2>
        <form id="registerForm">
            <div class="form-group">
                <label for="regName">Nome:</label>
                <input type="text" id="regName" required>
            </div>
            <div class="form-group">
                <label for="regEmail">E-mail:</label>
                <input type="email" id="regEmail" required>
            </div>
            <div class="form-group">
                <label for="regInstitution">Instituição:</label>
                <input type="text" id="regInstitution" required>
            </div>
            <div class="form-group">
                <label for="regProject">Projeto:</label>
                <input type="text" id="regProject" required>
            </div>
            <div class="form-group">
                <label for="regPassword">Senha:</label>
                <input type="password" id="regPassword" required>
            </div>
            <button type="submit" id="registerBtn">Cadastrar</button>
            <p><a href="#" id="showLoginLink">Voltar ao Login</a></p>
        </form>
    </div>

    <div id="dashboard" class="container hidden">
        <h2 id="userName"></h2>
        <p id="userEmail"></p>
        <p>Projeto: <span id="currentProject"></span></p>
        <button id="logoutBtn">Sair</button>

        <!-- Visão Geral -->
        <h3>Visão Geral</h3>
        <p>Relatórios: <span id="userReports">0</span></p>
        <p>Atividades: <span id="userActivities">0</span></p>
        <p>Arquivos: <span id="userFiles">0</span></p>

        <!-- Relatórios -->
        <h3>Relatórios</h3>
        <form id="reportForm">
            <div class="form-group">
                <label for="reportType">Tipo:</label>
                <select id="reportType" required>
                    <option value="Mensal">Mensal</option>
                    <option value="Final">Final</option>
                </select>
            </div>
            <div class="form-group">
                <label for="reportDate">Data:</label>
                <input type="date" id="reportDate" required>
            </div>
            <div class="form-group">
                <label for="reportTitle">Título:</label>
                <input type="text" id="reportTitle" required>
            </div>
            <div class="form-group">
                <label for="reportDescription">Descrição:</label>
                <textarea id="reportDescription" required></textarea>
            </div>
            <div class="form-group">
                <label for="reportFiles">Arquivos (Imagens, Docs, Planilhas, Apresentações):</label>
                <input type="file" id="reportFiles" multiple accept=".jpg,.jpeg,.png,.pdf,.doc,.docx,.xlsx,.csv,.ppt,.pptx" required>
                <div id="reportFileList" class="file-list"></div>
            </div>
            <button type="submit" id="submitReportBtn">Enviar Relatório</button>
        </form>

        <!-- Atividades -->
        <h3>Atividades</h3>
        <form id="activityForm">
            <div class="form-group">
                <label for="activityName">Nome:</label>
                <input type="text" id="activityName" required>
            </div>
            <div class="form-group">
                <label for="activityDate">Data:</label>
                <input type="date" id="activityDate" required>
            </div>
            <div class="form-group">
                <label for="activityDescription">Descrição:</label>
                <textarea id="activityDescription" required></textarea>
            </div>
            <div class="form-group">
                <label for="activityFiles">Arquivos (Imagens, Docs, Planilhas, Apresentações):</label>
                <input type="file" id="activityFiles" multiple accept=".jpg,.jpeg,.png,.pdf,.doc,.docx,.xlsx,.csv,.ppt,.pptx" required>
                <div id="activityFileList" class="file-list"></div>
            </div>
            <button type="submit" id="submitActivityBtn">Cadastrar Atividade</button>
        </form>

        <!-- Upload de Arquivos -->
        <h3>Upload de Arquivos</h3>
        <form id="fileUploadForm">
            <div class="form-group">
                <label for="fileCategory">Categoria:</label>
                <select id="fileCategory" required>
                    <option value="relatorios">Relatórios</option>
                    <option value="atividades">Atividades</option>
                    <option value="documentos">Documentos</option>
                    <option value="fotos">Fotos</option>
                    <option value="videos">Vídeos</option>
                    <option value="outros">Outros</option>
                </select>
            </div>
            <div class="form-group">
                <label for="fileDescription">Descrição:</label>
                <textarea id="fileDescription" required></textarea>
            </div>
            <div class="form-group">
                <label for="uploadFiles">Arquivos (Imagens, Docs, Planilhas, Apresentações):</label>
                <input type="file" id="uploadFiles" multiple accept=".jpg,.jpeg,.png,.pdf,.doc,.docx,.xlsx,.csv,.ppt,.pptx" required>
                <div id="uploadFileList" class="file-list"></div>
            </div>
            <button type="submit" id="uploadFilesBtn">Enviar Arquivos</button>
        </form>

        <!-- Administração (se admin) -->
        <div id="adminSection" class="hidden">
            <h3>Administração</h3>
            <p>Usuários: <span id="adminUsers">0</span></p>
            <p>Relatórios: <span id="adminReports">0</span></p>
            <p>Atividades: <span id="adminActivities">0</span></p>
            <p>Arquivos: <span id="adminFiles">0</span></p>
            <button id="exportDataBtn">Exportar Dados</button>
        </div>
    </div>

    <script>
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxW8iySGkZpzbreHqG78LGCL4NiHGBS9PdczQRAncNFUifD5a55v8iMhv7PfB6HVggD/exec';

        let currentUser = null;
        let isLoggedIn = false;

        function showMessage(message, type = 'info') {
            const messageArea = document.getElementById('messageArea');
            messageArea.innerHTML = <div class="message message-${type}">${message}</div>;
            setTimeout(() => messageArea.innerHTML = '', 5000);
        }

        async function sendRequest(action, data) {
            try {
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action, ...data, timestamp: new Date().toISOString() })
                });
                if (!response.ok) throw new Error(HTTP ${response.status}: ${response.statusText});
                const result = await response.json();
                if (!result.success) throw new Error(result.message || 'Erro no servidor');
                return result;
            } catch (error) {
                console.error('Erro na requisição:', error);
                showMessage('Erro de conexão ou servidor: ' + error.message, 'error');
                return { success: false, message: error.message };
            }
        }

        // Função para atualizar a lista de arquivos selecionados
        function updateFileList(inputId, listId) {
            const input = document.getElementById(inputId);
            const list = document.getElementById(listId);
            list.innerHTML = '';
            for (let file of input.files) {
                list.innerHTML += <p>${file.name} (${(file.size / 1024).toFixed(2)} KB)</p>;
            }
        }

        // Login, Cadastro, Logout, e outras funções permanecem como na última resposta

        // Envio de Relatório
        async function handleSubmitReport(event) {
            event.preventDefault();
            if (!currentUser) return showMessage('Faça login primeiro', 'error');

            const reportType = document.getElementById('reportType').value;
            const reportDate = document.getElementById('reportDate').value;
            const title = document.getElementById('reportTitle').value;
            const description = document.getElementById('reportDescription').value;
            const files = document.getElementById('reportFiles').files;
            if (!reportType || !reportDate || !title || !description || !files.length) return showMessage('Preencha todos os campos e selecione pelo menos um arquivo', 'error');

            const submitBtn = document.getElementById('submitReportBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Enviando...';

            const fileData = [];
            for (let file of files) {
                if (file.size > 10 * 1024 * 1024) {
                    showMessage(Arquivo ${file.name} excede o limite de 10 MB, 'error');
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Enviar Relatório';
                    return;
                }
                const reader = new FileReader();
                const base64 = await new Promise((resolve) => {
                    reader.onload = () => resolve(reader.result.split(',')[1]);
                    reader.readAsDataURL(file);
                });
                fileData.push({ name: file.name, data: base64, size: file.size, type: file.type });
            }

            const result = await sendRequest('submitReport', {
                email: currentUser.email,
                reportType,
                reportDate,
                title,
                description,
                files: fileData
            });
            if (result.success) {
                showMessage('Relatório enviado com sucesso!', 'success');
                document.getElementById('reportForm').reset();
                document.getElementById('reportFileList').innerHTML = '';
                loadUserData();
            } else {
                showMessage('Erro ao enviar relatório: ' + result.message, 'error');
            }
            submitBtn.disabled = false;
            submitBtn.textContent = 'Enviar Relatório';
        }

        // Cadastro de Atividade
        async function handleSubmitActivity(event) {
            event.preventDefault();
            if (!currentUser) return showMessage('Faça login primeiro', 'error');

            const activityName = document.getElementById('activityName').value;
            const activityDate = document.getElementById('activityDate').value;
            const description = document.getElementById('activityDescription').value;
            const files = document.getElementById('activityFiles').files;
            if (!activityName || !activityDate || !description || !files.length) return showMessage('Preencha todos os campos e selecione pelo menos um arquivo', 'error');

            const submitBtn = document.getElementById('submitActivityBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Cadastrando...';

            const fileData = [];
            for (let file of files) {
                if (file.size > 10 * 1024 * 1024) {
                    showMessage(Arquivo ${file.name} excede o limite de 10 MB, 'error');
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Cadastrar Atividade';
                    return;
                }
                const reader = new FileReader();
                const base64 = await new Promise((resolve) => {
                    reader.onload = () => resolve(reader.result.split(',')[1]);
                    reader.readAsDataURL(file);
                });
                fileData.push({ name: file.name, data: base64, size: file.size, type: file.type });
            }

            const result = await sendRequest('submitActivity', {
                email: currentUser.email,
                name: activityName,
                date: activityDate,
                description,
                files: fileData
            });
            if (result.success) {
                showMessage('Atividade cadastrada com sucesso!', 'success');
                document.getElementById('activityForm').reset();
                document.getElementById('activityFileList').innerHTML = '';
                loadUserData();
            } else {
                showMessage('Erro ao cadastrar atividade: ' + result.message, 'error');
            }
            submitBtn.disabled = false;
            submitBtn.textContent = 'Cadastrar Atividade';
        }

        // Upload de Arquivos
        async function handleUploadFiles(event) {
            event.preventDefault();
            if (!currentUser) return showMessage('Faça login primeiro', 'error');

            const category = document.getElementById('fileCategory').value;
            const description = document.getElementById('fileDescription').value;
            const files = document.getElementById('uploadFiles').files;
            if (!category || !description || !files.length) return showMessage('Preencha todos os campos e selecione pelo menos um arquivo', 'error');

            const uploadBtn = document.getElementById('uploadFilesBtn');
            uploadBtn.disabled = true;
            uploadBtn.textContent = 'Enviando...';

            const fileData = [];
            for (let file of files) {
                if (file.size > 10 * 1024 * 1024) {
                    showMessage(Arquivo ${file.name} excede o limite de 10 MB, 'error');
                    uploadBtn.disabled = false;
                    uploadBtn.textContent = 'Enviar Arquivos';
                    return;
                }
                const reader = new FileReader();
                const base64 = await new Promise((resolve) => {
                    reader.onload = () => resolve(reader.result.split(',')[1]);
                    reader.readAsDataURL(file);
                });
                fileData.push({ name: file.name, data: base64, size: file.size, type: file.type });
            }

            const result = await sendRequest('uploadFiles', {
                email: currentUser.email,
                category,
                description,
                files: fileData
            });
            if (result.success) {
                showMessage(${result.message}, 'success');
                document.getElementById('fileUploadForm').reset();
                document.getElementById('uploadFileList').innerHTML = '';
                loadUserData();
            } else {
                showMessage('Erro ao enviar arquivos: ' + result.message, 'error');
            }
            uploadBtn.disabled = false;
            uploadBtn.textContent = 'Enviar Arquivos';
        }

        // Inicialização
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('registerForm').addEventListener('submit', handleRegister);
            document.getElementById('reportForm').addEventListener('submit', handleSubmitReport);
            document.getElementById('activityForm').addEventListener('submit', handleSubmitActivity);
            document.getElementById('fileUploadForm').addEventListener('submit', handleUploadFiles);
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            document.getElementById('showRegisterLink').addEventListener('click', (e) => {
                e.preventDefault();
                document.getElementById('loginContainer').classList.add('hidden');
                document.getElementById('registerContainer').classList.remove('hidden');
            });
            document.getElementById('showLoginLink').addEventListener('click', (e) => {
                e.preventDefault();
                document.getElementById('registerContainer').classList.add('hidden');
                document.getElementById('loginContainer').classList.remove('hidden');
            });

            // Adicionar evento para atualizar a lista de arquivos
            ['reportFiles', 'activityFiles', 'uploadFiles'].forEach(inputId => {
                document.getElementById(inputId).addEventListener('change', (e) => {
                    updateFileList(inputId, ${inputId.replace('Files', 'FileList')});
                });
            });
        });
    </script>
</body>
</html>
