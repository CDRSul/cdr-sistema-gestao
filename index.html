<script>
/* ---------- CONFIGURAÇÃO ---------- */
const APPS_SCRIPT_URL =
  'https://script.google.com/macros/s/AKfycbxW8iySGkZpzbreHqG78LGCL4NiHGBS9PdczQRAncNFUifD5a55v8iMhv7PfB6HVggD/exec';

let currentUser = null;

/* ---------- CHAMADA GENÉRICA ---------- */
async function apiCall(payload, files = null) {
  let body, headers = {};

  if (files) {                                // FormData (upload)
    body = new FormData();
    Object.entries(payload).forEach(([k, v]) => body.append(k, v));
    files.forEach(f => body.append('file', f));     // um ou vários <input>
  } else {                                    // JSON normal
    body = JSON.stringify(payload);
    headers['Content-Type'] = 'application/json';
  }

  const res = await fetch(APPS_SCRIPT_URL, { method: 'POST', body, headers });
  if (!res.ok) throw new Error('Failed to fetch');
  return res.json();
}

/* ---------- UTIL DE MENSAGEM ---------- */
function msg(el, txt, err) {
  el.textContent = txt;
  el.className   = err ? 'error-message' : 'success-message';
}

/* ---------- LOGIN ---------- */
async function handleLogin(ev) {
  ev.preventDefault();
  const email = document.getElementById('loginEmail').value.trim();
  const pass  = document.getElementById('loginPassword').value.trim();
  const box   = document.getElementById('loginMsg');

  try {
    const out = await apiCall({ action: 'login', email, password: pass });
    if (!out.success) { msg(box, out.message, true); return; }

    currentUser = out.user;
    localStorage.setItem('cdr_user', JSON.stringify(currentUser));
    showDashboard(currentUser);
  } catch (e) { msg(box, e.message, true); }
}

/* ---------- ENVIO DE RELATÓRIO ---------- */
async function handleSubmitReport(ev) {
  ev.preventDefault();
  const f = ev.target, fileInput = document.getElementById('reportFiles');
  const files = [...fileInput.files];       // 0 ou 1

  const payload = {
    action      : 'submitReport',
    email       : currentUser.email,
    reportType  : document.getElementById('reportType').value,
    title       : document.getElementById('reportTitle').value,
    description : document.getElementById('reportDescription').value
  };

  try {
    const out = await apiCall(payload, files);
    alert(out.message);
    f.reset(); loadUserData();
  } catch (e) { alert('Erro: ' + e.message); }
}

/* ---------- ENVIO DE ATIVIDADE ---------- */
async function handleSubmitActivity(ev) {
  ev.preventDefault();
  const files = [...document.getElementById('activityFiles').files];

  const payload = {
    action : 'submitActivity',
    email  : currentUser.email,
    name   : document.getElementById('activityTitle').value,
    date   : document.getElementById('activityDate').value,
    description : document.getElementById('activityDescription').value
  };

  try {
    const out = await apiCall(payload, files);
    alert(out.message);
    ev.target.reset(); loadUserData();
  } catch (e) { alert('Erro: ' + e.message); }
}

/* ---------- ENVIO DE ARQUIVOS ---------- */
async function handleUploadFiles(ev) {
  ev.preventDefault();
  const files = [...document.getElementById('uploadFiles').files];
  if (!files.length) { alert('Selecione arquivo(s)'); return; }

  const payload = {
    action      : 'uploadFiles',
    email       : currentUser.email,
    category    : document.getElementById('fileCategory').value,
    description : document.getElementById('fileDescription').value
  };

  try {
    const out = await apiCall(payload, files);
    alert(out.message);
    ev.target.reset(); loadUserData();
  } catch (e) { alert('Erro: ' + e.message); }
}

/* ---------- ADMIN / ESTATÍSTICAS ---------- */
async function loadUserData() {
  if (!currentUser) return;
  const out = await apiCall({ action:'getUserStats', email:currentUser.email });
  if (out.success) {
    document.getElementById('statsReports'   ).textContent = out.stats.reports;
    document.getElementById('statsActivities').textContent = out.stats.activities;
    document.getElementById('statsFiles'     ).textContent = out.stats.files;
  }
}
async function loadAdminData() {
  if (!currentUser?.isAdmin) return;
  const out = await apiCall({ action:'getAdminData', email:currentUser.email });
  if (out.success) {
    document.getElementById('adminStatsUsers'     ).textContent = out.data.totalUsers;
    document.getElementById('adminStatsReports'   ).textContent = out.data.totalReports;
    document.getElementById('adminStatsActivities').textContent = out.data.totalActivities;
  }
}

/* ---------- BOOT ---------- */
document.addEventListener('DOMContentLoaded', () => {
  /* liga formulários já existentes no HTML original */
  document.getElementById('loginForm'   ).onsubmit = handleLogin;
  document.getElementById('reportForm'  ).onsubmit = handleSubmitReport;
  document.getElementById('activityForm').onsubmit = handleSubmitActivity;
  document.getElementById('filesForm'   ).onsubmit = handleUploadFiles;

  /* recupera usuário salvo */
  const saved = localStorage.getItem('cdr_user');
  if (saved) try { currentUser = JSON.parse(saved); showDashboard(currentUser); } catch{}
});
</script>
