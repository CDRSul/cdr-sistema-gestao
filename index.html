<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Sistema CDR Sul</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
body{font-family:sans-serif;margin:0;background:#f5f5f5}
.container{max-width:500px;margin:20px auto;background:#fff;padding:20px;
           border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.1)}
input,select,textarea{width:100%;padding:8px;margin:6px 0;border:1px solid #ddd;border-radius:4px}
button{padding:10px 16px;border:none;background:#4d6bff;color:#fff;border-radius:4px;cursor:pointer}
button:disabled{opacity:.6}
.hidden{display:none}
.message{margin:10px 0;padding:10px;border-radius:4px}
.message.error{background:#ffe5e5;color:#c00}
.message.success{background:#e8ffea;color:#11803b}
</style>
</head>
<body>

<!-- LOGIN ---------->
<div class="container" id="loginScreen">
  <h2>Login</h2>
  <div id="msgLogin"></div>
  <form id="loginForm">
    <input id="loginEmail" placeholder="E-mail" type="email" required>
    <input id="loginPass" placeholder="Senha" type="password" required>
    <button>Entrar</button>
  </form>
</div>

<!-- DASHBOARD ------>
<div class="container hidden" id="dashScreen">
  <h3>Bem-vindo, <span id="userName"></span></h3>
  <button id="btnLogout" style="background:#c00">Sair</button>

  <hr><h2>Enviar Arquivos</h2>
  <div id="msgUpload"></div>
  <form id="uploadForm">
    <select id="upCategory" required>
      <option value="">Categoria</option>
      <option>Documentos</option><option>Fotos</option><option>Outros</option>
    </select>
    <textarea id="upDesc" placeholder="Descrição"></textarea>
    <input id="upFiles" type="file" multiple required>
    <button>Enviar</button>
  </form>
</div>

<script>
const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxW8iySGkZpzbreHqG78LGCL4NiHGBS9PdczQRAncNFUifD5a55v8iMhv7PfB6HVggD/exec';
let currentUser = null;

/* ----------- Função genérica de chamada ----------- */
async function apiCall(payload, files=null){
  let body, headers={};
  if(files){                               // FormData
    body = new FormData();
    Object.entries(payload).forEach(([k,v])=>body.append(k,v));
    files.forEach(f=>body.append('file',f));
  }else{                                   // JSON
    body = JSON.stringify(payload);
    headers['Content-Type']='application/json';
  }
  const res = await fetch(APPS_SCRIPT_URL,{method:'POST',body,headers});
  if(!res.ok) throw new Error('HTTP '+res.status);
  return res.json();
}
/* ----------- util de mensagem --------------------- */
function showMsg(el,msg,err){
  el.innerHTML = '<div class="message '+(err?'error':'success')+'">'+msg+'</div>';
}

/* ----------- LOGIN -------------------------------- */
loginForm.addEventListener('submit', async e=>{
  e.preventDefault();
  try{
    const out = await apiCall({
      action:'login',
      email : loginEmail.value.trim(),
      password: loginPass.value.trim()
    });
    if(out.success){
      currentUser = out.user;
      userName.textContent = currentUser.name;
      loginScreen.classList.add('hidden');
      dashScreen.classList.remove('hidden');
    }else showMsg(msgLogin,out.message,true);
  }catch(err){ showMsg(msgLogin,err.message,true); }
});

/* ----------- UPLOAD ------------------------------- */
uploadForm.addEventListener('submit', async e=>{
  e.preventDefault();
  const files=[...upFiles.files];
  if(!files.length){showMsg(msgUpload,'Escolha arquivos',true);return;}
  try{
    const out = await apiCall({
      action:'uploadFiles',
      email:currentUser.email,
      category:upCategory.value,
      description:upDesc.value
    },files);
    showMsg(msgUpload,out.message,false);
    uploadForm.reset();
  }catch(err){ showMsg(msgUpload,err.message,true); }
});

/* ----------- LOGOUT ------------------------------- */
btnLogout.onclick = ()=>{
  currentUser=null;
  dashScreen.classList.add('hidden');
  loginScreen.classList.remove('hidden');
  loginForm.reset(); msgLogin.innerHTML='';
};
</script>
</body>
</html>
